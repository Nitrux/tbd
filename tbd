#! /bin/bash


shopt -s expand_aliases

alias put='printf "%b"'      \
      putln='printf "%b\n"'  \
      trace="2> '${e_trace:="$(mktemp)"}' " \
      quiet="> /dev/null trace" \
      qev='quiet eval'          \
      abort_on_error:='read __exit <<<'

r=$'\e[31m' g=$'\e[32m' i=$'\e[3m' n=$'\e[0m'

abort () {
    >&2 putln "\r${r}${1}${n}"
    ${__exit:=true} && { put "$i"; sed "s|^|    |" "$e_trace"; put "$u"; exit ${err:-1}; } \
                    || return ${err:-1}
}

++ () { : $(( ++$1 )); }

@ () { putln "${new_ln}\e[33m${*}${n}"; new_ln="\n"; }

- () {
    put "       $*"

    case "$2" in
        ( 'works' )   qev "$1";;
        ( 'fails' )   qev ! "$1";;
        ( 'prints' )  test "$(trace eval "$1")" = "$3";;

        ( * )  quiet "$2" "$1" "${@:3}";;
    esac

    _c=$?; ++ tests

    test $_c = 0 && { ++ good; putln "\r   ${g}ok${n}"; } \
                 || { ++ fail; abort " fail"; }
}

tbd_main () {
    trap 'rm "$e_trace"; putln "" "  ${i}${tests:-0} tests executed, ${good:-0} passed, ${fail:-0} failed.${n}"' \
        EXIT

    for tf in "${@:-testfile}"; do
        test -r "$tf" || abort "could not read from '$tf'."
        source "$tf"
    done

    ${__exit:=true} && exit $fail \
                    || exit 0
}

tbd_main "$@"
