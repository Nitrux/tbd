#! /bin/bash

ignore_errors: () { __x=${1}; }
tc () { 2> "${__et:=$(mktemp)}" "$@"; }
qq () { > /dev/null tc "$@"; }

@ () { printf "\e[1m\n$*\e[0m\n"; }

::et () { sed "s|^|    > |" "$__et"; exit 1; }
::no () { ((__no++)); printf "\r\e[31m  !!\e[0m\n"; ${__x:-false} || ::et; }
::ok () { ((__ok++)); printf "\r\e[32m  ok\e[0m\n"; }

- () {
    ((__tt++)); printf "%6s'${1}' ${*:2}"

    case "$2" in ( works  )  qq eval "$1";;
                 ( fails  )  qq eval "! $1";;
                 ( prints )  test "$(tc eval "$1")" = "$3";;
                 ( * )       qq "$2" "$1" "${@:3}";;
    esac \
        && ::ok || ::no
}

trap 'printf "\n\e[3m  ${__tt:-0} tests executed, ${__ok:-0} passed, ${__no:-0} failed.\e[0m\n\n"; rm "$__et"' \
    EXIT

for _ in "${@:-testfile}"; do source "$_"; done
